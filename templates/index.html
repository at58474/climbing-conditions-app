<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climbing Conditions Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/main.css') }}">

</head>
<body>
    <div class="container-fluid">
        <!-- Top bar -->
        <div class="top-bar">
            <!-- Insert top bar content if needed -->
        </div>
        <div class="content">
            <div class="sidebar">
                <!-- Climbing conditions section -->
                <div class="climbing-conditions-section">
                    <h3>Climbing Conditions</h3>
                    <form id="climbing-conditions-form">
                        <div>
                            <label for="destination">Select destination:</label>
                            <select id="destination" name="destination" class="form-control">
                                <option value="Black Canyon of the Gunnison, CO">Black Canyon of the Gunnison, CO</option>
                                <option value="Bishop, CA">Bishop, CA</option>
                                <option value="Boone, NC">Boone, NC</option>
                                <option value="Chattanooga, TN">Chattanooga, TN</option>
                                <option value="Devils Tower National Monument, WY">Devils Tower National Monument, WY</option>
                                <option value="Flagstaff, AZ">Flagstaff, AZ</option>
                                <option value="Hueco Tanks State Historic Site, TX">Hueco Tanks State Historic Site, TX</option>
                                <option value="Indian Creek, UT">Indian Creek, UT</option>
                                <option value="Joshua Tree National Park, CA">Joshua Tree National Park, CA</option>
                                <option value="Lander, WY">Lander, WY</option>
                                <option value="Leavenworth, WA">Leavenworth, WA</option>
                                <option value="Little Cottonwood Canyon, UT">Little Cottonwood Canyon, UT</option>
                                <option value="Looking Glass Rock, NC">Looking Glass Rock, NC</option>
                                <option value="Maple Canyon, UT">Maple Canyon, UT</option>
                                <option value="New River Gorge National Park, WV">New River Gorge National Park, WV</option>
                                <option value="Red River Gorge, KY">Red River Gorge, KY</option>
                                <option value="Red Rock Canyon, NV">Red Rock Canyon, NV</option>
                                <option value="Rifle Mountain Park, CO">Rifle Mountain Park, CO</option>
                                <option value="Rocky Mountain National Park, CO">Rocky Mountain National Park, CO</option>
                                <option value="Rumney, NH">Rumney, NH</option>
                                <option value="Shawangunks, NY">The Shawangunks, NY</option>
                                <option value="Smith Rock State Park, OR">Smith Rock State Park, OR</option>
                                <option value="Tacoma, WA">Tacoma, WA</option>
                                <option value="The Needles, CA">The Needles, CA</option>
                                <option value="Yosemite National Park, CA">Yosemite National Park, CA</option>
                                <option value="Zion National Park, UT">Zion National Park, UT</option>
                            </select>
                        </div>
                        <div style="text-align: center; margin-top: 1rem;">
                            <button type="button" id="get-climbing-conditions" class="btn btn-primary">Get Climbing Conditions</button>
                        </div>
                    </form>
                </div>
                <!-- RRG Current Conditions section -->
                <div class="current-conditions" id="current-conditions">
                    <div class="current-conditions-header">
                        <h5>RRG Current Conditions</h5>
                    </div>
                    <div class="current-conditions-body">
                        <p style="margin-bottom: 5px;"><strong style="color: #343a40;">Climbing Conditions Score:</strong> <span id="climbing-conditions-score" style="color: #343a40;">Calculating...</span></p>
                        <hr style="margin: 10px 0; border-color: #343a40;">
                        <div class="info-container">
                            <div class="column">
                                <p style="margin-bottom: 5px;"><strong style="color: #343a40;">Temperature:</strong> <span id="temperature" style="color: #343a40;">Calculating...</span> °F</p>
                                <p style="margin-bottom: 5px;"><strong style="color: #343a40;">Humidity:</strong> <span id="humidity" style="color: #343a40;">Calculating...</span>%</p>
                                <p style="margin-bottom: 5px;"><strong style="color: #343a40;">Dew Point:</strong> <span id="dew-point" style="color: #343a40;">Calculating...</span> °F</p>
                            </div>
                            <div class="column">
                                <!-- Additional information can be added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="main-content">
                <div class="graph-container" id="graph-container">
                    <div class="button-container" id="button-container" style="display: none;">
                        <button type="button" id="toggle-fullscreen" class="btn btn-secondary" style="width: 150px;">Fullscreen</button>
                    </div>
                </div>
                <!-- Instructions for reading the chart -->
                <div class="chart-instructions">
                    <h5><b><u>How To Use This App</u></b></h5>
                    <p>Purpose: Since weather conditions have such a tremendous impact on climbing performance, the goal for this application is to create a standardized score that can be used as a quick reference to assist in determining how the current and forecasted weather will affect climbing ability. Secondary goals are to assist in understanding the differences that exist between climbers, and also to help each individual climber understand how conditions affect their personal performance.</p>
                    <p>To use this app, simply select the desired location from the drop-down menu in the climbing conditions widget in the left sidebar, then click the Get Climbing Conditions button. A quick reference widget is also displayed in the side bar that displays the current conditions (default Red River Gorge).</p>
                    <p>A chart will be shown in the main area to the right of the sidebar. The generated chart will display the 5-day forecasted climbing conditions score (CCS) for the selected destination.</p>
                    <p><i>Note: Optimal conditions vary from climber to climber, so determining the CCS you perform the best at may be a learning experience.</i></p>
                    <h4>How to read and use the chart:</h4>

                        <p>The chart is broken into 3-hour sections, where each section will have the following properties:</p>
                        <li>Each 3-hour chart section will be shaded red, yellow, or green:
                            <ul>
                                <li><b><span style="color:red">Red</span></b> indicates poor conditions.</li>
                                <li><b><span style="color:yellow">Yellow</span></b> indicates good conditions.</li>
                                <li><b><span style="color:green">Green</span></b> indicates optimal conditions (better take off work)</li>
                            </ul>
                        </li>
                        <p><i>* Again, these colors are created based on the average climber, your personal experience may be slightly or significantly different.</i></p>
                        <li>The chart will either have a vertical shaded bar, or not:
                            <ul>
                                <li>If a vertical shaded bar is present, then that signifies the section is representing nighttime hours.</li>
                                <li>If a vertical shaded bar is absent, then the section represents daytime hours.</li>
                            </ul>
                        </li>
                        <li>Datapoints:
                            <ul>
                                <li>Each datapoint represents the CCS for the day and time listed on the x-axis. </li>
                                <li>To get more information, hover or tap the datapoint to display the forecasted CCS, Temperature, Humidity, and Dew Point.</li>
                                <li>If the datapoint is red then there will likely be condensation on the rock and the climbing conditions will be very bad.</li>
                                <li>A weather icon will be displayed in the x-axis label, along with the Day and Time (EST-12hr). The icon will give the forecasted conditions, sunny, partially cloudy, full cloud cover, rain, or snow. <i>Note: The sun icon at night just means a clear night, so read the icons accordingly.</i></li>
                            </ul>
                        </li>
                        <p>If viewing the application on a mobile device the chart can be best viewed by clicking the Fullscreen button then rotating your screen to the horizontal position.</p>
                        <p>The chart also contains numerous functions to that can assist in a better viewing experience.</p>
                </div>
                <br /><br />
                <div class="image-container">
                    <img src="{{ url_for('static', filename='2D_TH.png') }}" alt="2D">
                </div>
                <div class="image-container">
                    <img src="{{ url_for('static', filename='3D_THD.png') }}" alt="3D">
                </div>
                <br /><br /><br /><br />
            </div>
        </div>
    </div>
    <div class="footer">
        <p>© 2024 Rising Standard, LLC</p>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
    // Fetch current climbing conditions on page load
    fetchCurrentClimbingConditions();

    // Check if there's a selected destination in local storage and set it as the selected value in the dropdown
    var selectedDestination = localStorage.getItem('selectedDestination');
    if (selectedDestination) {
        document.getElementById('destination').value = selectedDestination;
    }

    document.getElementById('get-climbing-conditions').addEventListener('click', function() {
        var destination = document.getElementById('destination').value;
        axios.get('/graph?destination=' + destination)
            .then(function(response) {
                var data = response.data;
                var graphContainer = document.getElementById('graph-container');
                Plotly.newPlot(graphContainer, data, {responsive: true}); // Set responsive: true
                // Show the button container if a chart is displayed
                document.getElementById('button-container').style.display = 'block';
                // Store the selected destination in local storage
                localStorage.setItem('selectedDestination', destination);
            })
            .catch(function(error) {
                console.error('Error fetching climbing conditions data:', error);
            });
    });

    // Update current climbing conditions based on selected destination
    document.getElementById('destination').addEventListener('change', function() {
        fetchCurrentClimbingConditions();
        // Store the selected destination in local storage
        var destination = document.getElementById('destination').value;
        localStorage.setItem('selectedDestination', destination);
    });

    function fetchCurrentClimbingConditions() {
        var destination = document.getElementById('destination').value;
        axios.get('/current_conditions?destination=' + destination)
            .then(function(response) {
                var conditions = response.data;
                var conditionsHtml = `<h5>${destination} Current Conditions</h5>`;

                // Color the climbing conditions score text based on ranges
                var scoreColor = '';
                if (conditions.climbing_conditions_score < 4) {
                    scoreColor = 'red';
                } else if (conditions.climbing_conditions_score >= 4 && conditions.climbing_conditions_score <= 6) {
                    scoreColor = 'yellow';
                } else {
                    scoreColor = 'green';
                }

                // Display climbing conditions score with one decimal place and colored text
                var roundedScore = parseFloat(conditions.climbing_conditions_score.toFixed(1));
                conditionsHtml += `<p style="color: ${scoreColor};">CCS: ${roundedScore.toFixed(1)}</p>`;
                conditionsHtml += `<p>Temperature: ${conditions.temperature.toFixed(2)}°F</p>`;
                conditionsHtml += `<p>Humidity: ${conditions.humidity}%</p>`;
                conditionsHtml += `<p>Dew Point: ${conditions.dew_point.toFixed(2)}°F</p>`;

                document.getElementById('current-conditions').innerHTML = conditionsHtml;
            })
            .catch(function(error) {
                console.error('Error fetching current climbing conditions:', error);
            });
    }

    // Toggle fullscreen mode
    document.getElementById('toggle-fullscreen').addEventListener('click', function() {
        var graphContainer = document.getElementById('graph-container');
        if (!document.fullscreenElement) {
            graphContainer.requestFullscreen().catch(err => {
                console.error('Error attempting to enable full-screen mode:', err);
            });
        } else {
            document.exitFullscreen();
        }
        // Resize the chart when entering or exiting fullscreen mode
        setTimeout(() => {
            Plotly.Plots.resize(graphContainer);
        }, 1000); // Delay resizing to ensure fullscreen transition completes
    });

    // Detect fullscreen change
    document.addEventListener('fullscreenchange', function(event) {
        if (!document.fullscreenElement) {
            console.log('Exited fullscreen mode');
            // Reload the page when exiting fullscreen mode
            location.reload();
        }
    });

    // Resize the chart when the window size changes
    window.addEventListener('resize', function() {
        var graphContainer = document.getElementById('graph-container');
        Plotly.Plots.resize(graphContainer);
    });
});

</script>
</body>
</html>